name: Update VPN configs

on:
  schedule:
    - cron: "*/9 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-configs:
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download and install Xray
        run: |
          XRAY_VERSION=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          XRAY_VERSION=${XRAY_VERSION:-v1.8.4}
          echo "Installing Xray version: $XRAY_VERSION"
          
          wget -q "https://github.com/XTLS/Xray-core/releases/download/${XRAY_VERSION}/Xray-linux-64.zip" -O /tmp/xray.zip
          unzip -q /tmp/xray.zip -d /tmp/xray
          chmod +x /tmp/xray/xray
          sudo mv /tmp/xray/xray /usr/local/bin/xray
          rm -rf /tmp/xray /tmp/xray.zip
          
          xray version

      - name: Update VPN configs
        run: |
          export V2RAY_PATH=/usr/local/bin/xray
          export VPN_MAX_TOTAL_TIME=450
          python scripts/update_configs.py

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update VPN configs"
          file_pattern: "githubmirror/*.txt"



